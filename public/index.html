<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IKEA AU — Store vs Online Lookup</title>
  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0B1230;
      --card:rgba(255,255,255,.07);
      --stroke:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.68);
      --muted2:rgba(255,255,255,.50);
      --good:#32d583;
      --warn:#fdb022;
      --bad:#f97066;
      --accent:#7c3aed;
      --accent2:#06b6d4;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --shadow2: 0 12px 28px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% 0%, rgba(124,58,237,.25), transparent 55%),
        radial-gradient(1000px 700px at 90% 10%, rgba(6,182,212,.20), transparent 50%),
        radial-gradient(800px 600px at 40% 90%, rgba(16,185,129,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }
    .wrap{max-width:1100px; margin:0 auto; padding:28px 18px 46px;}
    .hero{
      position:relative;
      padding:22px 18px 14px;
      border-radius: calc(var(--radius) + 6px);
      background: linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hero::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(500px 300px at 20% 20%, rgba(124,58,237,.35), transparent 60%),
        radial-gradient(400px 260px at 80% 10%, rgba(6,182,212,.28), transparent 60%);
      filter: blur(14px);
      opacity:.8;
      pointer-events:none;
    }
    .hero > *{position:relative; z-index:1}
    h1{font-size: clamp(22px, 2.8vw, 34px); margin:0; letter-spacing:-.02em; line-height:1.15;}
    .sub{margin:8px 0 0; color:var(--muted); max-width: 90ch;}
    .badgeRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:12px;}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      color:var(--muted); font-size:12px;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
    }
    .chip b{color:var(--text); font-weight:600}
    .grid{margin-top:16px; display:grid; grid-template-columns: 1fr; gap:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .panel{
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .panelHeader{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .panelHeader h2{
      margin:0;
      font-size:14px;
      letter-spacing:.02em;
      color:var(--muted);
      font-weight:600;
      text-transform: uppercase;
    }
    .panelBody{padding:14px}
    .form{
      display:grid;
      grid-template-columns: 1.2fr .7fr .6fr .6fr auto;
      gap:10px; align-items:end;
    }
    @media (max-width: 980px){
      .form{grid-template-columns: 1fr 1fr;}
      .span2{grid-column: span 2;}
    .spanAll{grid-column: 1 / -1;}
      .form button{grid-column: span 2;}
    }
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px;}
    input, select{
      width:100%; padding:12px 12px; border-radius: 12px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      outline:none;
    }
    input::placeholder{color:rgba(255,255,255,.35)}
    input:focus, select:focus{
      border-color: rgba(124,58,237,.6);
      box-shadow: 0 0 0 3px rgba(124,58,237,.14);
    }
    .btn{
      cursor:pointer;
      padding:12px 14px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(135deg, rgba(124,58,237,.85), rgba(6,182,212,.75));
      color:white; font-weight:800; letter-spacing:.01em;
      box-shadow: 0 18px 45px rgba(124,58,237,.18);
      min-width: 140px;
    }
    .btn:disabled{opacity:.7; cursor:not-allowed}
    .btn.secondary{background: rgba(255,255,255,.06); color:var(--text); font-weight:600; box-shadow:none;}
    .loadingBar{height: 3px; width:100%; background: rgba(255,255,255,.06); position:relative; overflow:hidden; display:none;}
    .loadingBar::after{
      content:""; position:absolute; left:-30%; top:0; height:100%; width:30%;
      background: linear-gradient(90deg, transparent, rgba(124,58,237,.8), rgba(6,182,212,.7), transparent);
      animation: slide 1s linear infinite;
    }
    @keyframes slide { to { left: 100%; } }

    .errorBox{
      padding:12px; border-radius: 14px;
      border:1px solid rgba(249,112,102,.35);
      background: rgba(249,112,102,.10);
      color: rgba(255,255,255,.88);
      margin-top: 10px;
      font-size: 13px; line-height: 1.35;
      display:none;
    }

      .noticeBox {
        display: none;
        margin-top: 12px;
        padding: 12px 14px;
        border-radius: 12px;
        background: rgba(255,255,255,.07);
        border: 1px solid rgba(255,255,255,.14);
        color: rgba(255,255,255,.92);
        font-size: 14px;
        line-height: 1.35;
      }

    .product{display:grid; grid-template-columns: 160px 1fr; gap:14px; align-items:start; margin-top:14px;}
    @media (max-width: 620px){ .product{grid-template-columns:1fr} }
    .imgBox{
      border-radius: 16px; overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      aspect-ratio: 1 / 1;
      display:flex; align-items:center; justify-content:center;
    }
    .imgBox img{width:100%; height:100%; object-fit:cover}
    .meta h3{margin:0 0 8px; font-size:18px; letter-spacing:-.01em; line-height:1.2;}
    .meta p{margin:0 0 10px; color:var(--muted); line-height:1.4; font-size:13px;}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .pill{
      display:inline-flex; padding:6px 9px; border-radius:999px;
      font-size:12px; border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--muted);
      gap:6px; align-items:center;
    }
    .pill.good{color:rgba(50,213,131,.95); border-color:rgba(50,213,131,.35); background: rgba(50,213,131,.10)}
    .pill.warn{color:rgba(253,176,34,.95); border-color:rgba(253,176,34,.35); background: rgba(253,176,34,.10)}
    .pill.bad{color:rgba(249,112,102,.95); border-color:rgba(249,112,102,.35); background: rgba(249,112,102,.10)}
    .mono{font-family:var(--mono)}
    .kpis{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; margin-top:10px;}
    .kpi{
      border-radius: var(--radius2);
      padding:12px 12px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
    }
    .kpi .label{font-size:12px; color:var(--muted); margin-bottom:6px}
    .kpi .value{font-size:20px; font-weight:900; letter-spacing:-.01em}
    .kpi .hint{font-size:12px; color:var(--muted2); margin-top:6px; line-height:1.35}
    details{
      margin-top:12px;
      border-radius: 14px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    details[open]{
      max-height: 520px;
    }
    details[open]     summary{
      cursor:pointer;
      padding:12px;
      color:var(--muted);
      user-select:none;
      display:flex; align-items:center; justify-content:space-between;
    }
    pre{
      margin:0;
      padding:12px;
      overflow:auto;
      max-height: 240px;
      color:rgba(255,255,255,.82);
      font-size:12px;
      line-height:1.4;
      background: rgba(0,0,0,.25);
      border-top:1px solid rgba(255,255,255,.08);
      white-space: pre;
    }
    details[open] pre{ max-height: 55vh; }
    .footer{margin-top: 14px; font-size: 12px; color: var(--muted2); line-height:1.4;}
    .history{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
    .histBtn{
      cursor:pointer; padding:8px 10px; border-radius: 999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color: var(--muted);
      font-size: 12px;
    }
    .histBtn:hover{border-color: rgba(124,58,237,.45); color: rgba(255,255,255,.85)}

    /* Tabs (Results / Debug) */
    .tabs{display:flex; gap:6px; margin-top:10px; align-items:center;}
    .tab{
      cursor:pointer;
      padding:8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
    }
    .tab:hover{border-color: rgba(124,58,237,.45); color: rgba(255,255,255,.85)}
    .tab.active{
      background: rgba(124,58,237,.18);
      border-color: rgba(124,58,237,.55);
      color: rgba(255,255,255,.92);
    }
    .toast{
      display:none; position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
      padding: 10px 12px; border-radius: 999px; border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.45); color: rgba(255,255,255,.88);
      backdrop-filter: blur(10px); box-shadow: var(--shadow2);
      z-index: 999; font-size: 13px;
    }
  
  /* Reason code modal */
  .reasonLink { text-decoration: underline; color: inherit; }
  .modalOverlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.6);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 18px;
    z-index: 1000;
  }
  .modal {
    width: min(860px, 96vw);
    max-height: 86vh;
    overflow: auto;
    background: rgba(18,20,24,.98);
    border: 1px solid rgba(255,255,255,.12);
    border-radius: 14px;
    box-shadow: 0 18px 60px rgba(0,0,0,.45);
    padding: 16px;
  }
  .modalHeader {
    display:flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 10px;
  }
  .modalTitle {
    font-size: 16px;
    font-weight: 700;
  }
  .kvTable {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }
  .kvTable th, .kvTable td {
    border-top: 1px solid rgba(255,255,255,.08);
    padding: 10px 8px;
    text-align: left;
    vertical-align: top;
    font-size: 13px;
  }
  .kvTable th { width: 180px; color: rgba(255,255,255,.75); font-weight: 600; }

</style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <h1>Compares store to online</h1>
      <p class="sub">
        This runs from your server (Docker) so the browser never talks to IKEA directly — no CORS headaches.
        Enter an article number and compare <b>online</b> (market) vs <b>in-store</b> (store-specific) pricing, stock, and location.
        <span style="opacity:.9">In‑store data usually only works while the selected store is open (business hours).</span>
      </p>
      <div class="badgeRow">
        <div class="chip">Store: <b id="chipStore">Loading…</b></div>
        <div class="chip">Market: <b>Australia</b> • Lang: <b>en</b></div>
        <div class="chip">Input accepts: <b>40492331</b> or <b>404.923.31</b></div>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <div id="loading" class="loadingBar"></div>
        <div class="panelHeader">
          <h2>Lookup</h2>
        </div>

        <div class="panelBody">
          <div class="form">
            <div class="span2">
              <label for="article">Article number</label>
              <input id="article" placeholder="e.g. 50559793 or 505.597.93" value="40492331" />
            </div>

            <div class="spanAll">
              <label for="productUrl">Or paste IKEA product URL (optional)</label>
              <input id="productUrl" placeholder="e.g. https://www.ikea.com/au/en/p/sunnersta-...-10455151/" />
            </div>

            <div>
              <label for="storeSelect">Store</label>
              <select id="storeSelect" disabled>
                <option value="556">Loading stores…</option>
              </select>
            </div>

            <div>
              <label for="market">Market</label>
              <select id="market">
                <option value="au" selected>Australia</option>
              </select>
            </div>

            <div>
              <label for="lang">Language</label>
              <select id="lang">
                <option value="en" selected>en</option>
              </select>
            </div>

            <button class="btn" id="btnLookup">Lookup</button>
          </div>

          <div class="noticeBox" id="storeHoursBox" style="display:none;"></div>

          <div class="history" id="history"></div>
          <div class="errorBox" id="err"></div>
          <div class="noticeBox" id="notice"></div>

          <div class="product">
            <div class="imgBox" id="imgBox">
              <span style="color:rgba(255,255,255,.4); font-size:12px;">No image yet</span>
            </div>
            <div class="meta">
              <h3 id="prodTitle">—</h3>
              <p id="prodDesc">Enter an article number and hit Lookup.</p>

              <div class="tabs" id="tabs" role="tablist" aria-label="Result tabs">
                <button class="tab active" id="tabBtnResults" data-tab="results" type="button">Results</button>
                <button class="tab" id="tabBtnDebug" data-tab="debug" type="button">Debug</button>
              </div>

              <div id="tabResults">
                
                <div class="row" style="margin:10px 0 8px;">
                  <span class="pill" id="pillStatus">In-store Status: —</span>
                  <span class="pill" id="pillHomeDelivery">Home Delivery: —</span>
                  <span class="pill" id="pillClickCollect">Click &amp; Collect: —</span>
                  <span class="pill" id="pillFloor">Floor: —</span>
                  <span class="pill" id="pillDept">Dept: —</span>
                  <span class="pill" id="pillCode">Code: —</span>
                  <span class="pill mono" id="pillArticle">Article: —</span>
                </div>

                <div class="kpis">
                <div class="kpi">
                  <div class="label">In-store price (incl. GST)</div>
                  <div class="value" id="storePrice">—</div>
                  <div class="hint" id="storePriceHint">Source: IKEA scan-shop</div>
                </div>
                <div class="kpi">
                  <div class="label">Online price (incl. GST)</div>
                  <div class="value" id="onlinePrice">—</div>
                  <div class="hint" id="onlinePriceHint">Source: IKEA product-details</div>
                </div>
                
                <div class="kpi">
                  <div class="label">Next restock (in-store)</div>
                  <div class="value" id="restockNext">—</div>
                  <div class="hint" id="restockHint">Source: IKEA availability (if exposed)</div>
                </div>
                <div class="kpi">
                  <div class="label">In-store quantity</div>
                  <div class="value" id="storeQty">—</div>
                  <div class="hint" id="storeQtyHint">Source: availability + scan-shop max qty</div>
                </div>
                <div class="kpi">
                  <div class="label">Difference (Online − Store)</div>
                  <div class="value" id="diff">—</div>
                  <div class="hint" id="diffHint">Calculated when both prices exist</div>
                </div>
              </div>


              <div class="noticeBox" id="availabilityDetails" style="display:none; margin-top:10px;">
                <div><b>Availability details</b> <span class="muted">(reason codes are clickable)</span></div>
                <div style="margin-top:6px;">
                  <div class="row" style="gap:10px; flex-wrap:wrap;">
                    <span><span class="muted">In-store reason:</span> <a href="#" id="reasonInStore" class="mono reasonLink">—</a></span>
                    <span><span class="muted">Delivery reason:</span> <a href="#" id="reasonHomeDelivery" class="mono reasonLink">—</a></span>
                    <span><span class="muted">Click &amp; Collect reason:</span> <a href="#" id="reasonClickCollect" class="mono reasonLink">—</a></span>
                    <span><span class="muted">Range status:</span> <span id="rangeStatus" class="mono">—</span></span>
                  </div>
                </div>
                <div style="margin-top:10px;">
                  <div class="muted">Upcoming restocks (in-store):</div>
                  <div id="restockList" class="mono" style="white-space:pre-wrap;">—</div>
                </div>
              </div>

                <div class="row" style="margin-top:12px; gap:10px; flex-wrap:wrap;">
                  <a id="lnkProduct" class="btn secondary" href="#" target="_blank" rel="noopener" style="display:none;">Open product page</a>
                  <button class="btn secondary" id="btnCopyCd" type="button" style="display:none;" title="Copy a URL formatted for changedetection.io">Copy ChangeDetection link</button>
                </div>
              </div>

              <div id="tabDebug" style="display:none;">
                <div class="row" style="margin:10px 0 8px; gap:10px; flex-wrap:wrap;">
                  <button class="btn secondary" id="btnCopyApi" type="button" title="Copy the /api/lookup URL to clipboard">Copy API link</button>
                </div>
                <pre id="debug">—</pre>
              </div>
            </div>
          </div>

          <div class="footer">
            Tip: This page calls <span class="mono">/api/lookup</span> on this same server. That endpoint proxies IKEA requests server-side, so it works from any browser.
          </div>
        </div>
      </div>

    </div>
  </div>


  <div class="modalOverlay" id="reasonModal" role="dialog" aria-modal="true" aria-label="Reason code help">
    <div class="modal">
      <div class="modalHeader">
        <div class="modalTitle" id="reasonModalTitle">Reason code help</div>
        <button class="btn secondary" id="btnCloseReason" type="button">Close</button>
      </div>
      <div id="reasonModalBody"></div>
    </div>
  </div>

  <div class="toast" id="toast">Copied!</div>

  <script>
    const $ = (id) => document.getElementById(id);

    function toast(msg="Copied!") {
      const t = $("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => (t.style.display="none"), 1200);
    }

    function normalizeArticle(input) {
      return (input || "").toString().replace(/\D/g, "");
    }

    function money(n) {
      if (n === null || n === undefined || Number.isNaN(n)) return "—";
      const v = Number(n);
      const isWhole = Math.abs(v % 1) < 1e-9;
      return new Intl.NumberFormat("en-AU", {
        style: "currency",
        currency: "AUD",
        minimumFractionDigits: isWhole ? 0 : 2,
        maximumFractionDigits: 2
      }).format(v);
    }

    function stripTags(s) {
      return (s === null || s === undefined) ? "" : String(s).replace(/<[^>]*>/g, "");
    }

    function titleCase(s) {
      return (s || "").toString().toLowerCase().replace(/\b\w/g, (c) => c.toUpperCase());
    }

    function extractArticleFromUrl(s) {
      const str = (s || "").toString().trim();
      if (!str) return "";
      // IKEA AU article numbers are 8 digits. We take the *last* 8-digit sequence in the string.
      const matches = [...str.matchAll(/(\d{8})/g)];
      if (!matches.length) return "";
      return matches[matches.length - 1][1];
    }


    function setLoading(on) {
      $("loading").style.display = on ? "block" : "none";
      $("btnLookup").disabled = on;
    }

    function showError(msg) {
      const el = $("err");
      el.textContent = msg;
      el.style.display = "block";
    }

    function clearError() {
      const el = $("err");
      el.textContent = "";
      el.style.display = "none";
    }

    function showNotice(msg) {
      const el = $("notice");
      el.textContent = msg;
      el.style.display = "block";
    }

    function clearNotice() {
      const el = $("notice");
      el.textContent = "";
      el.style.display = "none";
    }


    function setImage(url) {
      const box = $("imgBox");
      box.innerHTML = "";
      if (!url) {
        box.innerHTML = '<span style="color:rgba(255,255,255,.4); font-size:12px;">No image</span>';
        return;
      }
      const img = new Image();
      img.src = url;
      img.alt = "Product image";
      img.loading = "lazy";
      img.referrerPolicy = "no-referrer";
      box.appendChild(img);
    }

    function statusPill(status) {
  const pill = $("pillStatus");
  pill.className = "pill";

  if (!status) {
    pill.textContent = "In-store Status: —";
    return;
  }

  const raw = String(status);
  const s = raw.toUpperCase();
  const pretty = titleCase(raw.replace(/_/g, " ").toLowerCase());

  pill.textContent = `In-store Status: ${pretty}`;

  if (s.includes("HIGH")) pill.classList.add("good");
  else if (s.includes("LOW") || s.includes("MED")) pill.classList.add("warn");
  else if (s.includes("OUT") || s.includes("NOT") || s.includes("NO_STOCK")) pill.classList.add("bad");
}


function setChannelPill(pillId, label, obj) {
  const pill = $(pillId);
  if (!pill) return;
  pill.className = "pill";

  let avail = obj?.available;
  let status = obj?.status ?? obj?.availability ?? null;

  let txt = "Unknown";
  if (avail === true) txt = "Available";
  else if (avail === false) txt = "Unavailable";
  else if (status) txt = titleCase(String(status).replace(/_/g, " ").toLowerCase());

  pill.textContent = `${label}: ${txt}`;

  const s = String(status || "").toUpperCase();
  if (avail === true || (s.includes("AVAILABLE") && !s.includes("UNAVAILABLE") && !s.includes("NOT_AVAILABLE"))) pill.classList.add("good");
  else if (avail === false || s.includes("UNAVAILABLE") || s.includes("NOT_AVAILABLE") || s.includes("OUT")) pill.classList.add("bad");
  else pill.classList.add("warn");
}

const REASON_CODE_HELP = {
  DISCONTINUED: {
    title: "Discontinued / end of range",
    meaning: "The article is no longer part of the active IKEA range (or is being phased out). Stock may not return."
  },
  END_OF_RANGE: {
    title: "End of range",
    meaning: "The article is leaving the range. Remaining stock may sell through and not be replenished."
  },
  NOT_SOLD_AT_STORE: {
    title: "Not sold at this store",
    meaning: "This article isn't ranged for the selected store (but may exist at other stores or online)."
  },
  OUT_OF_STOCK: {
    title: "Out of stock",
    meaning: "No stock is currently available for this fulfilment method. Restocks may appear if IKEA provides forecasts."
  },
  NO_STOCK: {
    title: "No stock",
    meaning: "No stock is available right now."
  },
  TEMPORARILY_UNAVAILABLE: {
    title: "Temporarily unavailable",
    meaning: "Stock or fulfilment is temporarily unavailable. This can be caused by stock movements, system updates, or slot capacity."
  },
  NOT_AVAILABLE: {
    title: "Not available",
    meaning: "This fulfilment method is not available right now."
  },
  NO_CLICKCOLLECT: {
    title: "Click & Collect unavailable",
    meaning: "Click & Collect is not available for the selected store right now."
  },
  NO_HOME_DELIVERY: {
    title: "Delivery unavailable",
    meaning: "Home Delivery is not available for this article right now."
  }
};

function pickReasonCode(reasonObj) {
  if (!reasonObj) return null;
  if (typeof reasonObj === "string") return reasonObj;
  const direct = reasonObj.code ?? reasonObj.reasonCode ?? reasonObj.unavailabilityReasonCode ?? reasonObj.unavailableReasonCode;
  if (direct) return String(direct);
  // common nested forms
  const nested = reasonObj.reason?.code ?? reasonObj.unavailabilityReason?.code ?? reasonObj.unavailableReason?.code;
  if (nested) return String(nested);
  if (Array.isArray(reasonObj.reasons) && reasonObj.reasons[0]?.code) return String(reasonObj.reasons[0].code);
  return null;
}


function escapeHtml(str) {
  return String(str ?? "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;");
}

function openReasonModal({ code, channel, raw }) {
  const overlay = $("reasonModal");
  const body = $("reasonModalBody");
  const title = $("reasonModalTitle");
  if (!overlay || !body || !title) return;

  const c = code ? String(code) : "—";
  const help = REASON_CODE_HELP[c] || null;

  title.textContent = `Reason code: ${c}${channel ? " (" + channel + ")" : ""}`;

  const knownRows = Object.entries(REASON_CODE_HELP).map(([k, v]) => {
    const sel = (k === c) ? " style=\"background: rgba(255,255,255,.06);\"" : "";
    return `<tr${sel}><th class="mono">${k}</th><td><b>${v.title}</b><div class="muted">${v.meaning}</div></td></tr>`;
  }).join("");

  const knownTable = `
    <table class="kvTable">
      <tr><th>Code</th><th>Meaning</th></tr>
      ${knownRows}
    </table>
  `;

  const rawBlock = raw ? `<h4 style="margin-top:14px;">Raw response</h4><pre>${escapeHtml(JSON.stringify(raw, null, 2))}</pre>` : "";

  body.innerHTML = `
    ${help ? `<div><b>${help.title}</b><div class="muted" style="margin-top:4px;">${help.meaning}</div></div>` : `<div class="muted">This reason code isn't in the known table. Showing raw response (if available) below.</div>`}
    ${knownTable}
    ${rawBlock}
  `;

  overlay.style.display = "flex";
}

function closeReasonModal() {
  const overlay = $("reasonModal");
  if (overlay) overlay.style.display = "none";
}

    // Recent history
    const HISTORY_KEY = "ikea_lookup_history_v1";
    function loadHistory() {
      try {
        const arr = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
        return Array.isArray(arr) ? arr : [];
      } catch { return []; }
    }
    function saveHistory(articleDigits) {
      const arr = loadHistory().filter(x => x !== articleDigits);
      arr.unshift(articleDigits);
      localStorage.setItem(HISTORY_KEY, JSON.stringify(arr.slice(0, 10)));
      renderHistory();
    }
    function renderHistory() {
      const arr = loadHistory();
      const wrap = $("history");
      wrap.innerHTML = "";
      if (!arr.length) return;
      arr.forEach(a => {
        const b = document.createElement("button");
        b.className = "histBtn mono";
        b.textContent = a;
        b.addEventListener("click", () => {
          $("article").value = a;
          lookup();
        });
        wrap.appendChild(b);
      });
    }

    function slugifyStoreName(name) {
      return (name || "")
        .toString()
        .trim()
        .toLowerCase()
        .replace(/&/g, "and")
        .replace(/[^a-z0-9\s-]/g, "")
        .replace(/\s+/g, "-")
        .replace(/-+/g, "-");
    }

    function setTab(tabName) {
      const isResults = tabName === "results";
      $("tabResults").style.display = isResults ? "block" : "none";
      $("tabDebug").style.display = isResults ? "none" : "block";
      $("tabBtnResults").classList.toggle("active", isResults);
      $("tabBtnDebug").classList.toggle("active", !isResults);
    }

    function getSelectedStore() {
      const sel = $("storeSelect");
      const opt = sel?.selectedOptions?.[0] || null;
      const id = (sel?.value || "").trim();
      const name = opt?.dataset?.name || opt?.textContent || "";
      const slug = opt?.dataset?.slug || slugifyStoreName(name);
      return { id, name: name.replace(/\s*\(\d+\)\s*$/, "").trim(), slug };
    }

    async function initStores() {
      const sel = $("storeSelect");
      sel.disabled = true;
      sel.innerHTML = `<option value="556">Loading stores…</option>`;

      let stores = [];
      try {
        const res = await fetch("/api/stores?country=au", { headers: { "accept": "application/json" } });
        if (res.ok) {
          const j = await res.json();
          stores = (j?.stores || []).map(s => ({
            id: String(s.id || "").trim(),
            name: String(s.name || "").trim(),
            slug: String(s.slug || "").trim() || slugifyStoreName(s.name)
          })).filter(s => s.id && s.name);
        }
      } catch {
        // ignore; we'll fall back to a minimal option
      }

      if (!stores.length) {
        stores = [{ id: "556", name: "Perth", slug: "perth" }];
      }

      stores.sort((a, b) => a.name.localeCompare(b.name));
      sel.innerHTML = "";
      for (const s of stores) {
        const o = document.createElement("option");
        o.value = s.id;
        o.textContent = `${s.name} (${s.id})`;
        o.dataset.slug = s.slug;
        o.dataset.name = s.name;
        sel.appendChild(o);
      }

      const stored = localStorage.getItem("ikea_store_id") || "";
      if (stored && [...sel.options].some(o => o.value === stored)) sel.value = stored;
      sel.disabled = false;

      updateStoreChip();
      await loadStoreHours();

      sel.addEventListener("change", async () => {
        localStorage.setItem("ikea_store_id", sel.value);
        updateStoreChip();
        await loadStoreHours();
      });
    }

    function updateStoreChip() {
      const s = getSelectedStore();
      const label = (s.name ? `${s.name} (${s.id})` : s.id) || "—";
      $("chipStore").textContent = label;
    }

    async function loadStoreHours() {
      const box = $("storeHoursBox");
      const s = getSelectedStore();
      if (!s.slug) {
        box.style.display = "none";
        return;
      }
      try {
        const res = await fetch(`/api/store-hours/${encodeURIComponent(s.slug)}`, {
          headers: { "accept": "application/json" }
        });
        if (!res.ok) throw new Error("hours fetch failed");
        const j = await res.json();
        const hours = Array.isArray(j?.hours) ? j.hours : [];
        if (!hours.length) {
          box.style.display = "none";
          return;
        }

        const lines = hours.map(h => `<div><b>${h.days}</b>: ${h.hours}</div>`).join("");
        const link = j?.url ? `<div style="margin-top:6px;"><a href="${j.url}" target="_blank" rel="noopener" class="mono" style="color:inherit; text-decoration:underline;">View store page</a></div>` : "";
        box.innerHTML = `<b>Store hours (selected store):</b> ${lines}${link}`;
        box.style.display = "block";
      } catch {
        box.style.display = "none";
      }
    }

    async function lookup() {
      clearError();
      clearNotice();
      setLoading(true);

      const market = $("market").value.trim() || "au";
      const lang = $("lang").value.trim() || "en";
      const store = getSelectedStore().id || "556";

      const urlVal = (($("productUrl") && $("productUrl").value) || "").trim();
      let articleDigits = normalizeArticle($("article").value);

      // Allow lookup by pasting an IKEA product URL (or even pasting a URL into the article field)
      const extracted = extractArticleFromUrl(urlVal || $("article").value);
      if (extracted) {
        articleDigits = extracted;
        $("article").value = extracted;
      }

      if (!articleDigits || articleDigits.length !== 8) {
        setLoading(false);
        showError("Please enter a valid 8-digit IKEA article number (e.g. 50559793 or 505.597.93), or paste an IKEA product URL.");
        return;
      }

      $("pillArticle").textContent = `Article: ${articleDigits}`;
      $("pillArticle").className = "pill mono";

      const apiPath = `/api/lookup?article=${encodeURIComponent(articleDigits)}&store=${encodeURIComponent(store)}&market=${encodeURIComponent(market)}&lang=${encodeURIComponent(lang)}`;

      try {
        const res = await fetch(apiPath, { headers: { "accept": "application/json" } });
        if (!res.ok) {
          const txt = await res.text().catch(() => "");
          throw new Error(`HTTP ${res.status}: ${txt.slice(0, 300)}`);
        }
        const data = await res.json();

        // Friendly handling when IKEA scan-shop is blocked during end-of-day / store closed
        if (data?.storeClosed) {
          clearError();
          clearNotice();
          showNotice(data?.storeClosedMessage || ":-( The store is currently closed. In-store price/location may be unavailable.");
        } else {
          clearNotice();
        }

        // Product details
        $("prodTitle").textContent = data?.product?.title ?? "—";
        $("prodDesc").textContent = data?.product?.description ?? "—";
        setImage(data?.product?.imageUrl ?? null);

        // Prices
        const storeRaw = data?.prices?.store?.raw ?? null;
        const onlineRaw = data?.prices?.online?.raw ?? null;
        $("storePrice").textContent = money(storeRaw);
        $("onlinePrice").textContent = money(onlineRaw);

        // Fulfilment (selected store)
        setChannelPill("pillHomeDelivery", "Home Delivery", data?.fulfilment?.homeDelivery || null);
        setChannelPill("pillClickCollect", "Click & Collect", data?.fulfilment?.clickCollect || null);

        // Restocks (in-store)
        const restocks = Array.isArray(data?.restocks?.inStore) ? data.restocks.inStore
          : (Array.isArray(data?.restocks) ? data.restocks : []);
        const next = restocks[0] || null;
        if (next && (next.date || next.quantity !== undefined)) {
          const d = next.date ? String(next.date) : "—";
          const q = (next.quantity !== null && next.quantity !== undefined) ? String(next.quantity) : "—";
          $("restockNext").textContent = `${d} (${q})`;
          $("restockHint").textContent = "Date (qty) if IKEA exposes restock forecasts";
        } else {
          $("restockNext").textContent = "—";
          $("restockHint").textContent = "No restock forecast exposed";
        }

        $("restockList").textContent = restocks.length
          ? restocks.map(r => {
              const d = r?.date ? String(r.date) : "—";
              const q = (r?.quantity !== null && r?.quantity !== undefined) ? String(r.quantity) : "—";
              return `${d}  qty ${q}`;
            }).join("
")
          : "—";

        // Reason codes / range status
        const rIn = data?.reasons?.inStore || null;
        const rHd = data?.reasons?.homeDelivery || null;
        const rCc = data?.reasons?.clickCollect || null;

        const codeIn = pickReasonCode(rIn) || "—";
        const codeHd = pickReasonCode(rHd) || "—";
        const codeCc = pickReasonCode(rCc) || "—";

        $("reasonInStore").textContent = codeIn;
        $("reasonHomeDelivery").textContent = codeHd;
        $("reasonClickCollect").textContent = codeCc;

        $("rangeStatus").textContent = (data?.range?.status ? String(data.range.status) : "—");

        window.__lastReasons = { inStore: rIn, homeDelivery: rHd, clickCollect: rCc };
        window.__lastRestocks = restocks;
        window.__lastRangeStatus = data?.range?.status || null;

        const showDetails = (codeIn !== "—" || codeHd !== "—" || codeCc !== "—" || (data?.range?.status) || restocks.length);
        $("availabilityDetails").style.display = showDetails ? "block" : "none";

        // Location pills
        const floor = data?.location?.floor ?? null;
        const dept = data?.location?.department ?? null;
        const code = data?.location?.code ?? null;
        $("pillFloor").textContent = `Floor: ${floor ?? "—"}`;
        $("pillDept").textContent = `Dept: ${dept ?? "—"}`;
        $("pillCode").textContent = `Code: ${code ?? "—"}`;

        // Stock
        statusPill(data?.stock?.status ?? null);

        $("storeQty").textContent = (data?.stock?.qty !== null && data?.stock?.qty !== undefined) ? String(data.stock.qty) : "—";

        const availText = data?.stock?.descriptionText ?? (data?.stock?.description ? stripTags(data.stock.description) : null);
        const itemLoc = data?.location?.itemLocationTextText ?? data?.location?.itemLocationText ?? null;

        $("storeQtyHint").textContent = [
          availText ? `availability: ${availText}` : null,
          itemLoc ? `itemLocation: ${stripTags(itemLoc)}` : null
        ].filter(Boolean).join(" • ") || "—";

        // Product URL
        const purl = data?.product?.productUrl ?? null;
        if (purl) {
          $("lnkProduct").href = purl;
          $("lnkProduct").style.display = "inline-flex";
        } else {
          $("lnkProduct").style.display = "none";
        }

        // ChangeDetection link button
        $("btnCopyCd").style.display = "inline-flex";

        // Diff
        if (typeof onlineRaw === "number" && typeof storeRaw === "number") {
          const d = onlineRaw - storeRaw;
          $("diff").textContent = money(d);
          $("diffHint").textContent = `Online ${money(onlineRaw)} − Store ${money(storeRaw)}`;
        } else {
          $("diff").textContent = "—";
          $("diffHint").textContent = "Calculated when both prices exist";
        }

        $("debug").textContent = JSON.stringify(data, null, 2);
        saveHistory(articleDigits);
      } catch (e) {
        showError(e?.message || String(e));
      } finally {
        setLoading(false);
      }
    }

    async function copyApiLink() {
      const market = $("market").value.trim() || "au";
      const lang = $("lang").value.trim() || "en";
      const store = getSelectedStore().id || "556";
      const articleDigits = normalizeArticle($("article").value);
      if (!articleDigits) return toast("Enter article first");
      const apiUrl = `${location.origin}/api/lookup?article=${articleDigits}&store=${store}&market=${market}&lang=${lang}`;
      try {
        await navigator.clipboard.writeText(apiUrl);
        toast("API link copied");
      } catch {
        toast("Clipboard blocked");
      }
    }

    async function copyChangedetectionLink() {
      const s = getSelectedStore();
      const store = s.id || "556";
      const articleDigits = normalizeArticle($("article").value);
      if (!articleDigits) return toast("Enter article first");
      const cdUrl = `${location.origin}/${store}/${articleDigits}`;
      try {
        await navigator.clipboard.writeText(cdUrl);
        toast("ChangeDetection link copied");
      } catch {
        toast("Clipboard blocked");
      }
    }

    $("tabBtnResults").addEventListener("click", () => setTab("results"));
    $("tabBtnDebug").addEventListener("click", () => setTab("debug"));

    $("btnLookup").addEventListener("click", lookup);
    $("btnCopyApi").addEventListener("click", copyApiLink);
    $("btnCopyCd").addEventListener("click", copyChangedetectionLink);


    // Reason code modal wiring
    $("btnCloseReason").addEventListener("click", closeReasonModal);
    $("reasonModal").addEventListener("click", (e) => { if (e.target === $("reasonModal")) closeReasonModal(); });
    document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeReasonModal(); });

    function wireReasonLink(anchorId, channelKey, channelLabel) {
      const a = $(anchorId);
      if (!a) return;
      a.addEventListener("click", (e) => {
        e.preventDefault();
        const raw = window.__lastReasons?.[channelKey] || null;
        const code = pickReasonCode(raw);
        if (!code && !raw) return;
        openReasonModal({ code: code || "—", channel: channelLabel, raw });
      });
    }
    wireReasonLink("reasonInStore", "inStore", "In-store");
    wireReasonLink("reasonHomeDelivery", "homeDelivery", "Home Delivery");
    wireReasonLink("reasonClickCollect", "clickCollect", "Click & Collect");

    $("article").addEventListener("keydown", (e) => { if (e.key === "Enter") lookup(); });
    $("productUrl").addEventListener("keydown", (e) => { if (e.key === "Enter") lookup(); });
    $("productUrl").addEventListener("blur", () => {
      const extracted = extractArticleFromUrl($("productUrl").value);
      if (extracted) $("article").value = extracted;
    });

    setTab("results");
    renderHistory();
    initStores().then(() => lookup());
  </script>
</body>
</html>