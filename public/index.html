<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IKEA AU — Store vs Online Lookup</title>
  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0B1230;
      --card:rgba(255,255,255,.07);
      --stroke:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.68);
      --muted2:rgba(255,255,255,.50);
      --good:#32d583;
      --warn:#fdb022;
      --bad:#f97066;
      --accent:#7c3aed;
      --accent2:#06b6d4;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --shadow2: 0 12px 28px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% 0%, rgba(124,58,237,.25), transparent 55%),
        radial-gradient(1000px 700px at 90% 10%, rgba(6,182,212,.20), transparent 50%),
        radial-gradient(800px 600px at 40% 90%, rgba(16,185,129,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }
    .wrap{max-width:1100px; margin:0 auto; padding:28px 18px 46px;}
    .hero{
      position:relative;
      padding:22px 18px 14px;
      border-radius: calc(var(--radius) + 6px);
      background: linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hero::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(500px 300px at 20% 20%, rgba(124,58,237,.35), transparent 60%),
        radial-gradient(400px 260px at 80% 10%, rgba(6,182,212,.28), transparent 60%);
      filter: blur(14px);
      opacity:.8;
      pointer-events:none;
    }
    .hero > *{position:relative; z-index:1}
    h1{font-size: clamp(22px, 2.8vw, 34px); margin:0; letter-spacing:-.02em; line-height:1.15;}
    .sub{margin:8px 0 0; color:var(--muted); max-width: 90ch;}
    .badgeRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:12px;}
    /* Brand / Logo */
    .brandRow{display:flex; gap:12px; align-items:flex-start;}
    .logoMark{
      width:44px; height:44px;
      border-radius: 16px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 16px 40px rgba(0,0,0,.25);
      display:flex; align-items:center; justify-content:center;
      flex: 0 0 auto;
    }
    .logoMark svg{width:26px; height:26px; opacity:.95}

    /* Action buttons */
    .actionRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    .actionBtn{
      display:inline-flex; align-items:center; gap:8px;
      padding:11px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.92);
      font-weight: 900;
      letter-spacing: .01em;
      text-decoration:none;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
    }
    .actionBtn:hover{border-color: rgba(124,58,237,.45); background: rgba(124,58,237,.12); transform: translateY(-1px);}
    .actionBtn:active{transform: translateY(0px);}
    .actionBtn .icon{width:16px; height:16px; opacity:.9}

    /* Store hours (collapsible) */
    details.hours{
      margin-top:12px;
      border-radius: var(--radius2);
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    details.hours summary{
      cursor:pointer;
      padding:12px 12px;
      list-style:none;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      user-select:none;
    }
    details.hours summary::-webkit-details-marker{display:none;}
    .hoursSum{display:flex; flex-direction:column; gap:2px;}
    .hoursTitle{font-size:12px; color:var(--muted); font-weight:900; text-transform:uppercase; letter-spacing:.06em;}
    .hoursMeta{font-size:13px; color:var(--muted2);}
    .chev{width:14px; height:14px; opacity:.75; transition: transform .15s ease;}
    details[open].hours .chev{transform: rotate(180deg);}
    .hoursBody{padding: 0 12px 12px;}
    .hoursTable{width:100%; border-collapse:collapse; margin-top:8px; font-size:13px;}
    .hoursTable td{padding:8px 0; border-bottom:1px solid rgba(255,255,255,.08); vertical-align:top;}
    .hoursTable tr:last-child td{border-bottom:none;}
    .hoursTable td:first-child{color:var(--muted); font-weight:800; width:34%;}
    .hoursLink{margin-top:10px; display:inline-flex; gap:8px; align-items:center; color: rgba(255,255,255,.88); text-decoration:underline;}

    /* Image carousel */
    .imgBox{position:relative;}
    .imgWrap{position:relative; width:100%; height:100%; cursor: zoom-in;}
    .imgNav{
      position:absolute; top:50%; transform: translateY(-50%);
      width:34px; height:34px; border-radius:999px;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.18);
      display:flex; align-items:center; justify-content:center;
      color: rgba(255,255,255,.9);
      opacity:0;
      transition: opacity .12s ease, transform .12s ease;
      cursor:pointer;
    }
    .imgNav.left{left:8px;}
    .imgNav.right{right:8px;}
    .imgNav:hover{border-color: rgba(124,58,237,.55); background: rgba(124,58,237,.22);}
    .imgBox:hover .imgNav{opacity:1;}
    .imgCounter{
      position:absolute; bottom:8px; right:8px;
      padding:6px 8px; border-radius:999px;
      background: rgba(0,0,0,.38);
      border:1px solid rgba(255,255,255,.18);
      color: rgba(255,255,255,.86);
      font-size:12px;
      font-family: var(--mono);
    }

    /* Fullscreen image modal */
    .imgModalCard{
      width: min(980px, 100%);
      border-radius: 18px;
      background: rgba(17,18,20,.98);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 18px 70px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .imgModalTop{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding: 12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .imgModalTitle{font-size:12px; color:var(--muted); font-weight:900; letter-spacing:.06em; text-transform:uppercase;}
    .imgModalBody{padding: 12px 12px 14px;}
    .imgModalImg{width:100%; max-height: 78vh; object-fit:contain; border-radius: 14px; border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.20);}
    .imgModalNavRow{display:flex; justify-content:space-between; gap:10px; margin-top:10px;}

    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      color:var(--muted); font-size:12px;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
    }
    .chip b{color:var(--text); font-weight:600}
    .grid{margin-top:16px; display:grid; grid-template-columns: 1fr; gap:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .panel{
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .panelHeader{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .panelHeader h2{
      margin:0;
      font-size:14px;
      letter-spacing:.02em;
      color:var(--muted);
      font-weight:600;
      text-transform: uppercase;
    }
    .panelBody{padding:14px}
    .form{
      display:grid;
      grid-template-columns: 1.2fr .7fr .6fr .6fr auto;
      gap:10px; align-items:end;
    }
    @media (max-width: 980px){
      .form{grid-template-columns: 1fr 1fr;}
      .span2{grid-column: span 2;}
    .spanAll{grid-column: 1 / -1;}
      .form button{grid-column: span 2;}
    }
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px;}
    input, select{
      width:100%; padding:12px 12px; border-radius: 12px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      outline:none;
    }
    input::placeholder{color:rgba(255,255,255,.35)}
    input:focus, select:focus{
      border-color: rgba(124,58,237,.6);
      box-shadow: 0 0 0 3px rgba(124,58,237,.14);
    }
    .btn{
      cursor:pointer;
      padding:12px 14px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(135deg, rgba(124,58,237,.85), rgba(6,182,212,.75));
      color:white; font-weight:800; letter-spacing:.01em;
      box-shadow: 0 18px 45px rgba(124,58,237,.18);
      min-width: 140px;
    }
    .btn:disabled{opacity:.7; cursor:not-allowed}
    .btn.secondary{background: rgba(255,255,255,.06); color:var(--text); font-weight:600; box-shadow:none;}
    .loadingBar{height: 3px; width:100%; background: rgba(255,255,255,.06); position:relative; overflow:hidden; display:none;}
    .loadingBar::after{
      content:""; position:absolute; left:-30%; top:0; height:100%; width:30%;
      background: linear-gradient(90deg, transparent, rgba(124,58,237,.8), rgba(6,182,212,.7), transparent);
      animation: slide 1s linear infinite;
    }
    @keyframes slide { to { left: 100%; } }

    .errorBox{
      padding:12px; border-radius: 14px;
      border:1px solid rgba(249,112,102,.35);
      background: rgba(249,112,102,.10);
      color: rgba(255,255,255,.88);
      margin-top: 10px;
      font-size: 13px; line-height: 1.35;
      display:none;
    }

      .noticeBox{
        display:none;
        margin-top: 12px;
        padding: 12px 14px;
        border-radius: 14px;
        background: rgba(255,255,255,.06);
        border: 1px solid rgba(255,255,255,.12);
        color: rgba(255,255,255,.92);
        font-size: 14px;
        line-height: 1.35;
        position: relative;
      }
      .noticeBox.closed{
        background: linear-gradient(135deg, rgba(253,176,34,.16), rgba(6,182,212,.06));
        border-color: rgba(253,176,34,.32);
        box-shadow: 0 10px 30px rgba(253,176,34,.08);
      }
      .noticeBox.closed::before{
        content:"";
        position:absolute;
        left:12px; top:10px; bottom:10px;
        width:3px;
        border-radius: 6px;
        background: linear-gradient(180deg, rgba(253,176,34,.85), rgba(249,112,102,.65));
        opacity:.9;
      }
      .noticeInner{display:flex; gap:12px; align-items:flex-start;}
      .noticeIcon{
        width:34px; height:34px; border-radius: 12px;
        display:flex; align-items:center; justify-content:center;
        background: rgba(253,176,34,.12);
        border:1px solid rgba(253,176,34,.22);
        flex:0 0 auto;
        margin-left: 4px; /* keeps the accent bar clear */
      }
      .noticeHeadline{font-weight:900; letter-spacing:-.01em;}
      .noticeSub{margin-top:2px; color: rgba(255,255,255,.86); font-size: 13px;}

      @keyframes noticeBounce {
        0%, 85%, 100% { transform: translateY(0); }
        88% { transform: translateY(-4px); }
        90% { transform: translateY(0); }
        92% { transform: translateY(-2px); }
        94% { transform: translateY(0); }
      }
      .noticeBox.closed .noticeIcon{ animation: noticeBounce 8s infinite; }
      @media (prefers-reduced-motion: reduce){
        .noticeBox.closed .noticeIcon{ animation: none !important; }
      }


.product{display:grid; grid-template-columns: 160px 1fr; gap:14px; align-items:start; margin-top:14px;}
    @media (max-width: 620px){ .product{grid-template-columns:1fr} }
    .imgBox{
      border-radius: 16px; overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      aspect-ratio: 1 / 1;
      display:flex; align-items:center; justify-content:center;
    }
    .imgBox img{width:100%; height:100%; object-fit:cover}
    .meta h3{margin:0 0 8px; font-size:18px; letter-spacing:-.01em; line-height:1.2;}
    .meta p{margin:0 0 10px; color:var(--muted); line-height:1.4; font-size:13px;}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .pill{
      display:inline-flex; padding:6px 9px; border-radius:999px;
      font-size:12px; border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--muted);
      gap:6px; align-items:center;
    }
    .pill.good{color:rgba(50,213,131,.95); border-color:rgba(50,213,131,.35); background: rgba(50,213,131,.10)}
    .pill.warn{color:rgba(253,176,34,.95); border-color:rgba(253,176,34,.35); background: rgba(253,176,34,.10)}
    .pill.bad{color:rgba(249,112,102,.95); border-color:rgba(249,112,102,.35); background: rgba(249,112,102,.10)}
    .mono{font-family:var(--mono)}
    .kpis{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; margin-top:10px;}
    .kpi{
      border-radius: var(--radius2);
      padding:12px 12px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
    }
    .kpi .label{font-size:12px; color:var(--muted); margin-bottom:6px}
    .kpi .value{font-size:20px; font-weight:900; letter-spacing:-.01em}
    .kpi .hint{font-size:12px; color:var(--muted2); margin-top:6px; line-height:1.35}

/* Extra cards (restocks + reason codes) */
.cardsRow{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; margin-top:12px;}
@media (max-width: 620px){ .cardsRow{grid-template-columns:1fr;} }
.card{
  border-radius: var(--radius2);
  padding:12px 12px;
  background: rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.10);
}
.cardTitle{font-size:12px; color:var(--muted); margin-bottom:8px; font-weight:900}
.cardBody{font-size:13px; color:rgba(255,255,255,.86); line-height:1.35}
.chipWrap{display:flex; gap:8px; flex-wrap:wrap;}
.chipBtn{
  cursor:pointer;
  display:inline-flex;
  gap:6px;
  align-items:center;
  padding:6px 9px;
  border-radius:999px;
  background: rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.12);
  color: rgba(255,255,255,.86);
  font-size:12px;
}
.chipBtn:hover{border-color: rgba(124,58,237,.45); color: rgba(255,255,255,.92)}
.muted{color:var(--muted2)}
.restockLine{margin:4px 0; font-size:13px; line-height:1.35}

/* Modal (reason code help) */
.modalOverlay{
  position: fixed; inset: 0;
  background: rgba(0,0,0,.62);
  display:flex; align-items:center; justify-content:center;
  padding: 18px;
  z-index: 999;
}
.modalCard{
  width: min(760px, 100%);
  border-radius: 18px;
  background: rgba(17,18,20,.98);
  border:1px solid rgba(255,255,255,.14);
  box-shadow: 0 18px 70px rgba(0,0,0,.55);
  overflow:hidden;
}
.modalHeader{
  display:flex; align-items:flex-start; justify-content:space-between;
  gap:12px;
  padding: 14px 14px;
  border-bottom: 1px solid rgba(255,255,255,.10);
}
.modalKicker{font-size:11px; color:var(--muted2); text-transform:uppercase; letter-spacing:.08em}
.modalTitle{font-size:16px; font-weight:900; letter-spacing:-.01em}
.modalContent{padding: 14px 14px; max-height: 72vh; overflow:auto;}
.modalSection{margin-bottom: 14px;}
.modalSubTitle{font-size:12px; color:var(--muted); font-weight:900; margin-bottom: 6px;}
.miniTableWrap{overflow:auto; border-radius: 12px; border:1px solid rgba(255,255,255,.10);}
.miniTable{width:100%; border-collapse:collapse; font-size:12px;}
.miniTable th, .miniTable td{padding:8px 10px; border-bottom:1px solid rgba(255,255,255,.08); vertical-align:top;}
.miniTable th{background: rgba(255,255,255,.04); color: rgba(255,255,255,.88); text-align:left;}
.miniPre{
  margin:0;
  padding:12px;
  overflow:auto;
  max-height: 32vh;
  color:rgba(255,255,255,.82);
  font-size:12px;
  line-height:1.4;
  background: rgba(0,0,0,.25);
  border:1px solid rgba(255,255,255,.08);
  border-radius: 12px;
  white-space: pre;
}
    details{
      margin-top:12px;
      border-radius: 14px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    details[open]{
      max-height: 520px;
    }
    details[open]     summary{
      cursor:pointer;
      padding:12px;
      color:var(--muted);
      user-select:none;
      display:flex; align-items:center; justify-content:space-between;
    }
    pre{
      margin:0;
      padding:12px;
      overflow:auto;
      max-height: 240px;
      color:rgba(255,255,255,.82);
      font-size:12px;
      line-height:1.4;
      background: rgba(0,0,0,.25);
      border-top:1px solid rgba(255,255,255,.08);
      white-space: pre;
    }
    details[open] pre{ max-height: 55vh; }
    .footer{margin-top: 14px; font-size: 12px; color: var(--muted2); line-height:1.4;}
    .history{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
    .histBtn{
      cursor:pointer; padding:8px 10px; border-radius: 999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color: var(--muted);
      font-size: 12px;
    }
    .histBtn:hover{border-color: rgba(124,58,237,.45); color: rgba(255,255,255,.85)}

    /* Tabs (Results / Debug) */
    .tabs{display:flex; gap:6px; margin-top:10px; align-items:center;}
    .tab{
      cursor:pointer;
      padding:8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
    }
    .tab:hover{border-color: rgba(124,58,237,.45); color: rgba(255,255,255,.85)}
    .tab.active{
      background: rgba(124,58,237,.18);
      border-color: rgba(124,58,237,.55);
      color: rgba(255,255,255,.92);
    }
    .toast{
      display:none; position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
      padding: 10px 12px; border-radius: 999px; border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.45); color: rgba(255,255,255,.88);
      backdrop-filter: blur(10px); box-shadow: var(--shadow2);
      z-index: 999; font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <div class="brandRow">
        <div class="logoMark" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M7 7.5h10" stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linecap="round"/>
            <path d="M7 12h6" stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linecap="round"/>
            <path d="M7 16.5h10" stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linecap="round"/>
            <path d="M16 10l4-4" stroke="rgba(6,182,212,.95)" stroke-width="2" stroke-linecap="round"/>
            <path d="M17 6h3v3" stroke="rgba(6,182,212,.95)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div>
          <h1>Store vs Online</h1>
          <p class="sub">
            Enter an article number and compare <b>online</b> (market) vs <b>in-store</b> (store-specific) pricing, stock, and location.
            <span style="opacity:.9">In‑store data usually only works while the selected store is open (business hours).</span>
          </p>
        </div>
      </div>
      <div class="badgeRow">
        <div class="chip">Store: <b id="chipStore">Loading…</b></div>
        <div class="chip">Market: <b>Australia</b> • Lang: <b>en</b></div>
        <div class="chip">Input accepts: <b>40492331</b> or <b>404.923.31</b></div>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <div id="loading" class="loadingBar"></div>
        <div class="panelHeader">
          <h2>Lookup</h2>
        </div>

        <div class="panelBody">
          <div class="form">
            <div class="span2">
              <label for="article">Article number</label>
              <input id="article" placeholder="e.g. 50559793 or 505.597.93" value="40492331" />
            </div>

            <div class="spanAll">
              <label for="productUrl">Or paste IKEA product URL (optional)</label>
              <input id="productUrl" placeholder="e.g. https://www.ikea.com/au/en/p/sunnersta-...-10455151/" />
            </div>

            <div>
              <label for="storeSelect">Store</label>
              <select id="storeSelect" disabled>
                <option value="556">Loading stores…</option>
              </select>
            </div>

            <div>
              <label for="market">Market</label>
              <select id="market">
                <option value="au" selected>Australia</option>
              </select>
            </div>

            <div>
              <label for="lang">Language</label>
              <select id="lang">
                <option value="en" selected>en</option>
              </select>
            </div>

            <button class="btn" id="btnLookup">Lookup</button>
          </div>

          <details class="hours" id="storeHoursBox" style="display:none;">
            <summary>
              <div class="hoursSum">
                <div class="hoursTitle">Store hours</div>
                <div class="hoursMeta" id="storeHoursMeta">—</div>
              </div>
              <svg class="chev" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M5 7.5l5 5 5-5" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </summary>
            <div class="hoursBody" id="storeHoursBody"></div>
          </details>

          <div class="history" id="history"></div>
          <div class="errorBox" id="err"></div>
          <div class="noticeBox" id="notice"></div>

          <div class="product">
            <div class="imgBox" id="imgBox">
              <span style="color:rgba(255,255,255,.4); font-size:12px;">No image yet</span>
            </div>
            <div class="meta">
              <h3 id="prodTitle">—</h3>
              <p id="prodDesc">Enter an article number and hit Lookup.</p>

              <div class="tabs" id="tabs" role="tablist" aria-label="Result tabs">
                <button class="tab active" id="tabBtnResults" data-tab="results" type="button">Results</button>
                <button class="tab" id="tabBtnDebug" data-tab="debug" type="button">Debug</button>
              </div>

              <div id="tabResults">
                <div class="row" style="margin:10px 0 8px;">
                  <span class="pill" id="pillInStoreStatus">In-store Status: —</span>
                  <span class="pill" id="pillClickCollect">Click &amp; Collect: —</span>
                  <span class="pill" id="pillHomeDelivery">Home delivery: —</span>
                  <span class="pill" id="pillFloor">Floor: —</span>
                  <span class="pill" id="pillDept">Dept: —</span>
                  <span class="pill" id="pillCode">Code: —</span>
                  <span class="pill mono" id="pillArticle">Article: —</span>
                </div>

                <div class="kpis">
                <div class="kpi">
                  <div class="label">In-store price (incl. GST)</div>
                  <div class="value" id="storePrice">—</div>
                  <div class="hint" id="storePriceHint">Source: IKEA scan-shop</div>
                </div>
                <div class="kpi">
                  <div class="label">Online price (incl. GST)</div>
                  <div class="value" id="onlinePrice">—</div>
                  <div class="hint" id="onlinePriceHint">Source: IKEA product-details</div>
                </div>
<div class="kpi">
                  <div class="label">In-store quantity</div>
                  <div class="value" id="storeQty">—</div>
                  <div class="hint" id="storeQtyHint">Source: Ingka CIA quantity (fallback: scan-shop)</div>
                </div>
                <div class="kpi">
                  <div class="label">Difference (Online − Store)</div>
                  <div class="value" id="diff">—</div>
                  <div class="hint" id="diffHint">Calculated when both prices exist</div>
                </div>
              </div>

<div class="cardsRow" style="margin-top:12px;">
  <div class="card" id="restockCard" style="display:none;">
    <div class="cardTitle">Restock estimate (in‑store)</div>
    <div class="cardBody" id="restockBody">—</div>
    <div class="hint" id="restockHint">Source: Ingka CIA restocks (best effort)</div>
  </div>
  <div class="card" id="reasonCard" style="display:none;">
    <div class="cardTitle">Availability reason codes</div>
    <div class="cardBody" id="reasonBody">—</div>
    <div class="hint">Tap a code for meaning + raw payload.</div>
  </div>
</div>

                <div class="actionRow">
                  <a id="lnkProduct" class="actionBtn" href="#" target="_blank" rel="noopener" style="display:none;">
                    <svg class="icon" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                      <path d="M8 5h-2.2A1.8 1.8 0 0 0 4 6.8v7.4A1.8 1.8 0 0 0 5.8 16H13.2A1.8 1.8 0 0 0 15 14.2V12" stroke="rgba(255,255,255,.9)" stroke-width="1.8" stroke-linecap="round"/>
                      <path d="M11 4h5v5" stroke="rgba(6,182,212,.95)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M16 4l-7 7" stroke="rgba(6,182,212,.95)" stroke-width="1.8" stroke-linecap="round"/>
                    </svg>
                    Open product page
                  </a>
                  <button class="actionBtn" id="btnCopyCd" type="button" style="display:none;" title="Copy a URL formatted for changedetection.io">
                    <svg class="icon" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                      <path d="M8 7h-1.2A2.8 2.8 0 0 0 4 9.8v3.4A2.8 2.8 0 0 0 6.8 16h3.4A2.8 2.8 0 0 0 13 13.2V12" stroke="rgba(255,255,255,.9)" stroke-width="1.8" stroke-linecap="round"/>
                      <path d="M12 8h1.2A2.8 2.8 0 0 1 16 10.8v3.4A2.8 2.8 0 0 1 13.2 17H9.8A2.8 2.8 0 0 1 7 14.2V13" stroke="rgba(124,58,237,.95)" stroke-width="1.8" stroke-linecap="round"/>
                    </svg>
                    Copy ChangeDetection URL
                  </button>
                </div>
              </div>

              <div id="tabDebug" style="display:none;">
                <div class="row" style="margin:10px 0 8px; gap:10px; flex-wrap:wrap;">
                  <button class="actionBtn" id="btnCopyApi" type="button" title="Copy the /api/lookup URL to clipboard">Copy API link</button>
                </div>
                <pre id="debug">—</pre>
              </div>
            </div>
          </div>
</div>
      </div>

    </div>
  </div>

  

<div class="modalOverlay" id="imgModal" style="display:none;">
  <div class="imgModalCard" role="dialog" aria-modal="true" aria-labelledby="imgModalTitle">
    <div class="imgModalTop">
      <div>
        <div class="imgModalTitle" id="imgModalTitle">Product image</div>
        <div class="hint" id="imgModalMeta">—</div>
      </div>
      <button class="actionBtn" id="btnImgClose" type="button" title="Close">
        <svg class="icon" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M6 6l8 8" stroke="rgba(255,255,255,.9)" stroke-width="1.8" stroke-linecap="round"/>
          <path d="M14 6l-8 8" stroke="rgba(255,255,255,.9)" stroke-width="1.8" stroke-linecap="round"/>
        </svg>
        Close
      </button>
    </div>
    <div class="imgModalBody">
      <img id="imgModalImg" class="imgModalImg" alt="Product image" />
      <div class="imgModalNavRow" id="imgModalNav" style="display:none;">
        <button class="actionBtn" id="btnImgPrev" type="button">
          <svg class="icon" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M12.5 5l-5 5 5 5" stroke="rgba(255,255,255,.9)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Prev
        </button>
        <button class="actionBtn" id="btnImgNext" type="button">
          Next
          <svg class="icon" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M7.5 5l5 5-5 5" stroke="rgba(255,255,255,.9)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modalOverlay" id="reasonModal" style="display:none;">
  <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="reasonTitle">
    <div class="modalHeader">
      <div>
        <div class="modalKicker">Reason code</div>
        <div class="modalTitle" id="reasonTitle">—</div>
      </div>
      <button class="actionBtn" id="btnReasonClose" type="button" title="Close">Close</button>
    </div>
    <div class="modalContent">
      <div class="modalSection" id="reasonExplain">—</div>

      <div class="modalSection">
        <div class="modalSubTitle">Known codes</div>
        <div class="miniTableWrap">
          <table class="miniTable" id="reasonTable">
            <thead><tr><th>Code</th><th>Meaning</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="modalSection">
        <div class="modalSubTitle">Raw response</div>
        <pre class="miniPre" id="reasonRaw">—</pre>
      </div>
    </div>
  </div>
</div>

  <div class="toast" id="toast">Copied!</div>

  <script>
    const $ = (id) => document.getElementById(id);

    function toast(msg="Copied!") {
      const t = $("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => (t.style.display="none"), 1200);
    }

    async function copyTextToClipboard(text) {
      if (!text) return false;
      // Modern clipboard API (requires secure context)
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
          return true;
        }
      } catch {}
      // Fallback for http / older browsers
      try {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.setAttribute('readonly', '');
        ta.style.position = 'fixed';
        ta.style.left = '-1000px';
        ta.style.top = '-1000px';
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        const ok = document.execCommand('copy');
        document.body.removeChild(ta);
        return ok;
      } catch {
        return false;
      }
    }

    function normalizeArticle(input) {
      return (input || "").toString().replace(/\D/g, "");
    }

    function money(n) {
      if (n === null || n === undefined || Number.isNaN(n)) return "—";
      const v = Number(n);
      const isWhole = Math.abs(v % 1) < 1e-9;
      return new Intl.NumberFormat("en-AU", {
        style: "currency",
        currency: "AUD",
        minimumFractionDigits: isWhole ? 0 : 2,
        maximumFractionDigits: 2
      }).format(v);
    }

    function stripTags(s) {
      return (s === null || s === undefined) ? "" : String(s).replace(/<[^>]*>/g, "");
    }

    function titleCase(s) {
      return (s || "").toString().toLowerCase().replace(/\b\w/g, (c) => c.toUpperCase());
    }

    function extractArticleFromUrl(s) {
      const str = (s || "").toString().trim();
      if (!str) return "";
      // IKEA AU article numbers are 8 digits. We take the *last* 8-digit sequence in the string.
      const matches = [...str.matchAll(/(\d{8})/g)];
      if (!matches.length) return "";
      return matches[matches.length - 1][1];
    }


    function setLoading(on) {
      $("loading").style.display = on ? "block" : "none";
      $("btnLookup").disabled = on;
    }

    function showError(msg) {
      const el = $("err");
      el.textContent = msg;
      el.style.display = "block";
    }

    function clearError() {
      const el = $("err");
      el.textContent = "";
      el.style.display = "none";
    }

    function showNotice(msg) {
      const el = $("notice");
      // This notice is currently used for the "store closed" state.
      el.classList.add("closed");
      el.innerHTML = "";

      const inner = document.createElement("div");
      inner.className = "noticeInner";

      const icon = document.createElement("div");
      icon.className = "noticeIcon";
      icon.innerHTML = '<svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M10 2.5c-4.14 0-7.5 3.36-7.5 7.5s3.36 7.5 7.5 7.5 7.5-3.36 7.5-7.5S14.14 2.5 10 2.5Z" stroke="rgba(255,255,255,.92)" stroke-width="1.6"/><path d="M10 6v4.6" stroke="rgba(255,255,255,.92)" stroke-width="1.8" stroke-linecap="round"/><path d="M10 14.4h.01" stroke="rgba(255,255,255,.92)" stroke-width="3" stroke-linecap="round"/></svg>';

      const txt = document.createElement("div");
      txt.className = "noticeText";

      const head = document.createElement("div");
      head.className = "noticeHeadline";
      head.textContent = "Store closed";

      const sub = document.createElement("div");
      sub.className = "noticeSub";
      const clean = stripTags(msg).replace(/^:\-\(\s*/,"").trim();
      sub.textContent = clean || "The selected store is currently closed. In-store price/location may be unavailable.";

      txt.appendChild(head);
      txt.appendChild(sub);

      inner.appendChild(icon);
      inner.appendChild(txt);

      el.appendChild(inner);
      el.style.display = "block";
    }

    function clearNotice() {
      const el = $("notice");
      el.classList.remove("closed");
      el.innerHTML = "";
      el.style.display = "none";
    }

    // Image carousel state
    const IMG_STATE = { urls: [], index: 0 };

    function setImages(urls) {
      IMG_STATE.urls = Array.isArray(urls) ? urls.filter(Boolean) : [];
      IMG_STATE.index = 0;
      renderImage();
    }

    function renderImage() {
      const box = $("imgBox");
      box.innerHTML = "";
      const urls = IMG_STATE.urls;
      if (!urls.length) {
        box.innerHTML = '<span style="color:rgba(255,255,255,.4); font-size:12px;">No image</span>';
        return;
      }

      const wrap = document.createElement('div');
      wrap.className = 'imgWrap';

      const img = new Image();
      img.src = urls[IMG_STATE.index];
      img.alt = 'Product image';
      img.loading = 'lazy';
      img.referrerPolicy = 'no-referrer';
      wrap.appendChild(img);

      // Arrows if multiple images
      if (urls.length > 1) {
        const left = document.createElement('button');
        left.type = 'button';
        left.className = 'imgNav left';
        left.innerHTML = '<svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12.5 5l-5 5 5 5" stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
        left.addEventListener('click', (e) => {
          e.stopPropagation();
          IMG_STATE.index = (IMG_STATE.index - 1 + urls.length) % urls.length;
          renderImage();
        });

        const right = document.createElement('button');
        right.type = 'button';
        right.className = 'imgNav right';
        right.innerHTML = '<svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7.5 5l5 5-5 5" stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
        right.addEventListener('click', (e) => {
          e.stopPropagation();
          IMG_STATE.index = (IMG_STATE.index + 1) % urls.length;
          renderImage();
        });

        const counter = document.createElement('div');
        counter.className = 'imgCounter';
        counter.textContent = `${IMG_STATE.index + 1}/${urls.length}`;

        wrap.appendChild(left);
        wrap.appendChild(right);
        wrap.appendChild(counter);
      }

      wrap.addEventListener('click', () => openImageModal());
      box.appendChild(wrap);
    }

    function openImageModal() {
      const urls = IMG_STATE.urls;
      if (!urls.length) return;
      $("imgModalImg").src = urls[IMG_STATE.index];
      $("imgModalImg").referrerPolicy = 'no-referrer';
      $("imgModalMeta").textContent = urls.length > 1 ? `Image ${IMG_STATE.index + 1} of ${urls.length}` : 'Image 1 of 1';
      $("imgModalNav").style.display = urls.length > 1 ? 'flex' : 'none';
      $("imgModal").style.display = 'flex';
    }

    function closeImageModal() {
      $("imgModal").style.display = 'none';
    }

    function imagePrev() {
      const urls = IMG_STATE.urls;
      if (urls.length < 2) return;
      IMG_STATE.index = (IMG_STATE.index - 1 + urls.length) % urls.length;
      $("imgModalImg").src = urls[IMG_STATE.index];
      $("imgModalMeta").textContent = `Image ${IMG_STATE.index + 1} of ${urls.length}`;
      renderImage();
    }

    function imageNext() {
      const urls = IMG_STATE.urls;
      if (urls.length < 2) return;
      IMG_STATE.index = (IMG_STATE.index + 1) % urls.length;
      $("imgModalImg").src = urls[IMG_STATE.index];
      $("imgModalMeta").textContent = `Image ${IMG_STATE.index + 1} of ${urls.length}`;
      renderImage();
    }

    function setStockPill(el, label, status) {
  el.className = "pill";
  if (!status) {
    el.textContent = `${label}: —`;
    return;
  }
  const raw = String(status);
  const s = raw.toUpperCase();
  const pretty = titleCase(raw.replace(/_/g, " ").toLowerCase());
  el.textContent = `${label}: ${pretty}`;

  if (s.includes("HIGH")) el.classList.add("good");
  else if (s.includes("LOW") || s.includes("MED")) el.classList.add("warn");
  else if (s.includes("OUT") || s.includes("NOT") || s.includes("NO_STOCK")) el.classList.add("bad");
}

function setRangePill(el, label, opt) {
  el.className = "pill";
  if (!opt) {
    el.textContent = `${label}: —`;
    return;
  }

  if (opt.inRange) {
    // In range, but we can still show stock signal if returned
    const s = String(opt.status || "").toUpperCase();
    if (s.includes("OUT")) {
      el.textContent = `${label}: Available (Out of stock)`;
      el.classList.add("bad");
    } else if (s.includes("LOW") || s.includes("MED")) {
      el.textContent = `${label}: Available (Low stock)`;
      el.classList.add("warn");
    } else {
      el.textContent = `${label}: Available`;
      el.classList.add("good");
    }
  } else {
    el.textContent = `${label}: Unavailable`;
    el.classList.add("bad");
  }
}

const REASON_CODE_INFO = {
  "AFTER_SALES_PERIOD": "End of sales period (generally discontinued).",
  "NOT_SOLD_TEMP": "Temporarily not sold/ranged for this store or fulfilment method (may return).",
  "NOT_IN_RANGE": "Not offered via this fulfilment method for this store/region (not a stock issue)."
};

function buildReasonTable() {
  const tbody = $("reasonTable").querySelector("tbody");
  tbody.innerHTML = "";
  for (const [code, meaning] of Object.entries(REASON_CODE_INFO)) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td class="mono">${code}</td><td>${meaning}</td>`;
    tbody.appendChild(tr);
  }
}

function openReasonModal(code, raw) {
  $("reasonTitle").textContent = code ? code : "(no code)";
  const meaning = code && REASON_CODE_INFO[code] ? REASON_CODE_INFO[code] : null;
  $("reasonExplain").innerHTML = meaning
    ? `<b>${meaning}</b><div class="hint" style="margin-top:6px;">If this doesn’t match what you’re seeing, use the raw response below.</div>`
    : `<b>Unknown reason code.</b><div class="hint" style="margin-top:6px;">This code isn’t in our known table yet. Raw response shown below.</div>`;

  $("reasonRaw").textContent = raw ? JSON.stringify(raw, null, 2) : "—";
  $("reasonModal").style.display = "flex";
}

function closeReasonModal() {
  $("reasonModal").style.display = "none";
}

function updateReasonCard(cia) {
  const card = $("reasonCard");
  const body = $("reasonBody");

  const items = [];
  const add = (label, opt) => {
    if (!opt) return;
    if (opt.inRange) return; // only show when unavailable
    const code = opt?.reason?.code ?? null;
    const raw = opt?.reason?.raw ?? opt?.reason ?? null;
    items.push({ label, code, raw });
  };

  add("In-store", cia?.cashCarry);
  add("Click & Collect", cia?.clickCollect);
  add("Home delivery", cia?.homeDelivery);

  if (!items.length) {
    card.style.display = "none";
    body.textContent = "—";
    return;
  }

  card.style.display = "block";
  body.innerHTML = "";
  const wrap = document.createElement("div");
  wrap.className = "chipWrap";

  items.forEach((it) => {
    const b = document.createElement("button");
    b.type = "button";
    b.className = "chipBtn mono";
    const codeText = it.code ? it.code : "(no code)";
    b.textContent = `${it.label}: ${codeText}`;
    b.addEventListener("click", () => openReasonModal(it.code, it.raw));
    wrap.appendChild(b);
  });

  body.appendChild(wrap);
}

function updateRestockCard(cashCarry) {
  const card = $("restockCard");
  const body = $("restockBody");

  const restocks = cashCarry?.restocks || [];
  if (!Array.isArray(restocks) || restocks.length === 0) {
    card.style.display = "none";
    body.textContent = "—";
    return;
  }

  card.style.display = "block";
  body.innerHTML = "";

  const list = document.createElement("div");
  list.className = "restockList";

  restocks.forEach((r) => {
    const line = document.createElement("div");
    line.className = "restockLine";
    const d1 = r.earliestDate || "—";
    const d2 = r.latestDate || "—";
    const q = (r.quantity !== null && r.quantity !== undefined) ? `${r.quantity} units` : "—";
    const rel = r.reliability ? `reliability ${r.reliability}` : "";
    line.innerHTML = `<span class="mono">${d1}</span> → <span class="mono">${d2}</span> <span class="muted">(${q}${rel ? `, ${rel}` : ""})</span>`;
    list.appendChild(line);
  });

  body.appendChild(list);
}

function updateAvailability(data) {
  const cia = data?.cia || null;

  const pillStore = $("pillInStoreStatus");
  const pillCC = $("pillClickCollect");
  const pillHD = $("pillHomeDelivery");

  // Defaults
  pillStore.className = "pill";
  pillCC.className = "pill";
  pillHD.className = "pill";
  pillStore.textContent = "In-store Status: —";
  pillCC.textContent = "Click & Collect: —";
  pillHD.textContent = "Home delivery: —";

  // CIA missing: fallback to legacy in-store status only
  if (!cia) {
    if (data?.storeClosed) {
      pillStore.textContent = "In-store Status: Store closed";
      pillStore.classList.add("warn");
    } else {
      setStockPill(pillStore, "In-store Status", data?.stock?.status ?? null);
    }
    $("reasonCard").style.display = "none";
    $("restockCard").style.display = "none";
    return;
  }

  // In-store (cash & carry)
  if (data?.storeClosed) {
    pillStore.textContent = "In-store Status: Store closed";
    pillStore.classList.add("warn");
  } else if (cia?.cashCarry && cia.cashCarry.inRange === false) {
    pillStore.textContent = "In-store Status: Unavailable";
    pillStore.classList.add("bad");
  } else {
    // Prefer CIA messageType if present, else fall back to old status
    setStockPill(pillStore, "In-store Status", cia?.cashCarry?.status ?? data?.stock?.status ?? null);
  }

  // Other buying options (selected store)
  setRangePill(pillCC, "Click & Collect", cia?.clickCollect ?? null);
  setRangePill(pillHD, "Home delivery", cia?.homeDelivery ?? null);

  // Restocks (in-store only)
  updateRestockCard(cia?.cashCarry ?? null);

  // Reason codes (only when unavailable)
  updateReasonCard(cia);
}


    // Recent history
    const HISTORY_KEY = "ikea_lookup_history_v1";
    function loadHistory() {
      try {
        const arr = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
        return Array.isArray(arr) ? arr : [];
      } catch { return []; }
    }
    function saveHistory(articleDigits) {
      const arr = loadHistory().filter(x => x !== articleDigits);
      arr.unshift(articleDigits);
      localStorage.setItem(HISTORY_KEY, JSON.stringify(arr.slice(0, 10)));
      renderHistory();
    }
    function renderHistory() {
      const arr = loadHistory();
      const wrap = $("history");
      wrap.innerHTML = "";
      if (!arr.length) return;
      arr.forEach(a => {
        const b = document.createElement("button");
        b.className = "histBtn mono";
        b.textContent = a;
        b.addEventListener("click", () => {
          $("article").value = a;
          lookup();
        });
        wrap.appendChild(b);
      });
    }

    function slugifyStoreName(name) {
      return (name || "")
        .toString()
        .trim()
        .toLowerCase()
        .replace(/&/g, "and")
        .replace(/[^a-z0-9\s-]/g, "")
        .replace(/\s+/g, "-")
        .replace(/-+/g, "-");
    }

    function setTab(tabName) {
      const isResults = tabName === "results";
      $("tabResults").style.display = isResults ? "block" : "none";
      $("tabDebug").style.display = isResults ? "none" : "block";
      $("tabBtnResults").classList.toggle("active", isResults);
      $("tabBtnDebug").classList.toggle("active", !isResults);
    }

    function getSelectedStore() {
      const sel = $("storeSelect");
      const opt = sel?.selectedOptions?.[0] || null;
      const id = (sel?.value || "").trim();
      const name = opt?.dataset?.name || opt?.textContent || "";
      const slug = opt?.dataset?.slug || slugifyStoreName(name);
      return { id, name: name.replace(/\s*\(\d+\)\s*$/, "").trim(), slug };
    }

    async function initStores() {
      const sel = $("storeSelect");
      sel.disabled = true;
      sel.innerHTML = `<option value="556">Loading stores…</option>`;

      let stores = [];
      try {
        const res = await fetch("/api/stores?country=au", { headers: { "accept": "application/json" } });
        if (res.ok) {
          const j = await res.json();
          stores = (j?.stores || []).map(s => ({
            id: String(s.id || "").trim(),
            name: String(s.name || "").trim(),
            slug: String(s.slug || "").trim() || slugifyStoreName(s.name)
          })).filter(s => s.id && s.name);
        }
      } catch {
        // ignore; we'll fall back to a minimal option
      }

      if (!stores.length) {
        stores = [{ id: "556", name: "Perth", slug: "perth" }];
      }

      stores.sort((a, b) => a.name.localeCompare(b.name));
      sel.innerHTML = "";
      for (const s of stores) {
        const o = document.createElement("option");
        o.value = s.id;
        o.textContent = `${s.name} (${s.id})`;
        o.dataset.slug = s.slug;
        o.dataset.name = s.name;
        sel.appendChild(o);
      }

      const stored = localStorage.getItem("ikea_store_id") || "";
      if (stored && [...sel.options].some(o => o.value === stored)) sel.value = stored;
      sel.disabled = false;

      updateStoreChip();
      await loadStoreHours();

      sel.addEventListener("change", async () => {
        localStorage.setItem("ikea_store_id", sel.value);
        updateStoreChip();
        await loadStoreHours();
      });
    }

    function updateStoreChip() {
      const s = getSelectedStore();
      const label = (s.name ? `${s.name} (${s.id})` : s.id) || "—";
      $("chipStore").textContent = label;
    }

    async function loadStoreHours() {
      const box = $("storeHoursBox");
      const meta = $("storeHoursMeta");
      const body = $("storeHoursBody");
      const s = getSelectedStore();
      if (!s.slug) {
        box.style.display = "none";
        return;
      }
      try {
        const res = await fetch(`/api/store-hours/${encodeURIComponent(s.slug)}`, {
          headers: { "accept": "application/json" }
        });
        if (!res.ok) throw new Error("hours fetch failed");
        const j = await res.json();
        const hours = Array.isArray(j?.hours) ? j.hours : [];
        if (!hours.length) {
          box.style.display = "none";
          return;
        }

        meta.textContent = `${s.name || s.slug} (${s.id})`;

        const rows = hours.map(h => {
          const day = h.days || "—";
          const hr = h.hours || "—";
          return `<tr><td>${day}</td><td>${hr}</td></tr>`;
        }).join("");

        const table = `<table class="hoursTable"><tbody>${rows}</tbody></table>`;
        const link = j?.url ? `<a class="hoursLink" href="${j.url}" target="_blank" rel="noopener">View store page</a>` : "";
        body.innerHTML = table + link;
        box.style.display = "block";
      } catch {
        box.style.display = "none";
      }
    }

    async function lookup() {
      clearError();
      clearNotice();
      setLoading(true);

      const market = $("market").value.trim() || "au";
      const lang = $("lang").value.trim() || "en";
      const store = getSelectedStore().id || "556";

      const urlVal = (($("productUrl") && $("productUrl").value) || "").trim();
      let articleDigits = normalizeArticle($("article").value);

      // Allow lookup by pasting an IKEA product URL (or even pasting a URL into the article field)
      const extracted = extractArticleFromUrl(urlVal || $("article").value);
      if (extracted) {
        articleDigits = extracted;
        $("article").value = extracted;
      }

      if (!articleDigits || articleDigits.length !== 8) {
        setLoading(false);
        showError("Please enter a valid 8-digit IKEA article number (e.g. 50559793 or 505.597.93), or paste an IKEA product URL.");
        return;
      }

      $("pillArticle").textContent = `Article: ${articleDigits}`;
      $("pillArticle").className = "pill mono";

      const apiPath = `/api/lookup?article=${encodeURIComponent(articleDigits)}&store=${encodeURIComponent(store)}&market=${encodeURIComponent(market)}&lang=${encodeURIComponent(lang)}`;

      try {
        const res = await fetch(apiPath, { headers: { "accept": "application/json" } });
        if (!res.ok) {
          const txt = await res.text().catch(() => "");
          throw new Error(`HTTP ${res.status}: ${txt.slice(0, 300)}`);
        }
        const data = await res.json();

        // Friendly handling when IKEA scan-shop is blocked during end-of-day / store closed
        if (data?.storeClosed) {
          clearError();
          clearNotice();
          showNotice(data?.storeClosedMessage || ":-( The store is currently closed. In-store price/location may be unavailable.");
        } else {
          clearNotice();
        }

        // Product details
        $("prodTitle").textContent = data?.product?.title ?? "—";
        $("prodDesc").textContent = data?.product?.description ?? "—";
        setImages(data?.product?.imageUrls ?? (data?.product?.imageUrl ? [data.product.imageUrl] : []));

        // Prices
        const storeRaw = data?.prices?.store?.raw ?? null;
        const onlineRaw = data?.prices?.online?.raw ?? null;
        $("storePrice").textContent = money(storeRaw);
        $("onlinePrice").textContent = money(onlineRaw);

        // Location pills
        const floor = data?.location?.floor ?? null;
        const dept = data?.location?.department ?? null;
        const code = data?.location?.code ?? null;
        $("pillFloor").textContent = `Floor: ${floor ?? "—"}`;
        $("pillDept").textContent = `Dept: ${dept ?? "—"}`;
        $("pillCode").textContent = `Code: ${code ?? "—"}`;

        // Availability (in-store + delivery/click&collect)
        updateAvailability(data);

                const storeQtyVal = (data?.cia?.cashCarry?.qty !== null && data?.cia?.cashCarry?.qty !== undefined) ? data.cia.cashCarry.qty : (data?.stock?.qty ?? null);
        $("storeQty").textContent = (storeQtyVal !== null && storeQtyVal !== undefined) ? String(storeQtyVal) : "—";

        const availText = data?.stock?.descriptionText ?? (data?.stock?.description ? stripTags(data.stock.description) : null);
        const itemLoc = data?.location?.itemLocationTextText ?? data?.location?.itemLocationText ?? null;

        $("storeQtyHint").textContent = [
          availText ? `availability: ${availText}` : null,
          itemLoc ? `itemLocation: ${stripTags(itemLoc)}` : null
        ].filter(Boolean).join(" • ") || "—";

        // Product URL
        const purl = data?.product?.productUrl ?? null;
        if (purl) {
          $("lnkProduct").href = purl;
          $("lnkProduct").style.display = "inline-flex";
        } else {
          $("lnkProduct").style.display = "none";
        }

        // ChangeDetection link button
        $("btnCopyCd").style.display = "inline-flex";

        // Diff
        if (typeof onlineRaw === "number" && typeof storeRaw === "number") {
          const d = onlineRaw - storeRaw;
          $("diff").textContent = money(d);
          $("diffHint").textContent = `Online ${money(onlineRaw)} − Store ${money(storeRaw)}`;
        } else {
          $("diff").textContent = "—";
          $("diffHint").textContent = "Calculated when both prices exist";
        }

        $("debug").textContent = JSON.stringify(data, null, 2);
        saveHistory(articleDigits);
      } catch (e) {
        showError(e?.message || String(e));
      } finally {
        setLoading(false);
      }
    }

    async function copyApiLink() {
      const market = $("market").value.trim() || "au";
      const lang = $("lang").value.trim() || "en";
      const store = getSelectedStore().id || "556";
      const articleDigits = normalizeArticle($("article").value);
      if (!articleDigits) return toast("Enter article first");
      const apiUrl = `${location.origin}/api/lookup?article=${articleDigits}&store=${store}&market=${market}&lang=${lang}`;
      const ok = await copyTextToClipboard(apiUrl);
      toast(ok ? "API link copied" : "Copy failed");
    }

    async function copyChangedetectionLink() {
      const s = getSelectedStore();
      const store = s.id || "556";
      const articleDigits = normalizeArticle($("article").value);
      if (!articleDigits) return toast("Enter article first");
      const cdUrl = `${location.origin}/${store}/${articleDigits}`;
      const ok = await copyTextToClipboard(cdUrl);
      toast(ok ? "ChangeDetection URL copied" : "Copy failed");
    }

    $("tabBtnResults").addEventListener("click", () => setTab("results"));
    $("tabBtnDebug").addEventListener("click", () => setTab("debug"));

    $("btnLookup").addEventListener("click", lookup);
    $("btnCopyApi").addEventListener("click", copyApiLink);
    $("btnCopyCd").addEventListener("click", copyChangedetectionLink);

    // Image modal wiring
    $("btnImgClose").addEventListener("click", closeImageModal);
    $("imgModal").addEventListener("click", (e) => { if (e.target && e.target.id === "imgModal") closeImageModal(); });
    $("btnImgPrev").addEventListener("click", imagePrev);
    $("btnImgNext").addEventListener("click", imageNext);

    $("article").addEventListener("keydown", (e) => { if (e.key === "Enter") lookup(); });
    $("productUrl").addEventListener("keydown", (e) => { if (e.key === "Enter") lookup(); });
    $("productUrl").addEventListener("blur", () => {
      const extracted = extractArticleFromUrl($("productUrl").value);
      if (extracted) $("article").value = extracted;
    });


    // Reason code modal wiring
    buildReasonTable();
    $("btnReasonClose").addEventListener("click", closeReasonModal);
    $("reasonModal").addEventListener("click", (e) => {
      if (e.target && e.target.id === "reasonModal") closeReasonModal();
    });
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        if ($("reasonModal").style.display !== "none") closeReasonModal();
        if ($("imgModal").style.display !== "none") closeImageModal();
      }
      if (e.key === "ArrowLeft" && $("imgModal").style.display !== "none") imagePrev();
      if (e.key === "ArrowRight" && $("imgModal").style.display !== "none") imageNext();
    });

    setTab("results");
    renderHistory();
    initStores().then(() => lookup());
  </script>
</body>
</html>